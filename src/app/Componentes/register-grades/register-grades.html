<!-- src/app/Componentes/register-grades/register-grades.html -->
<div class="container my-4" style="max-width:1100px;">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-3">Gestión de Notas</h2>
    <a class="btn btn-secondary" routerLink="/grade-report">Ver reportes</a>
  </div>

  <div class="row g-3 mb-4">
    <div class="col-md-6">
      <label class="form-label">Sección</label>
      <select class="form-select"
              [(ngModel)]="seccionId"
              name="seccionId"
              (change)="onSeccionChange()">
        <option [ngValue]="null">-- Selecciona --</option>
        <option *ngFor="let s of secciones" [ngValue]="s.id">
          {{ getCursoCode(s) }} - {{ s.nombre }}
        </option>
      </select>
    </div>
    <div class="col-md-6">
      <label class="form-label">Estudiante</label>
      <select class="form-select"
              [(ngModel)]="estudianteId"
              name="estudianteId">
        <option [ngValue]="null">-- Selecciona --</option>
        <option *ngFor="let e of estudiantes" [ngValue]="e.id">
          {{ (e.codigo || e.id) }} - {{ studentName(e) }}
        </option>
      </select>
    </div>
  </div>

  <form class="border rounded p-4 mb-4 bg-light" (ngSubmit)="guardar()" #formNotas="ngForm">
    <div class="row g-3">
      <div class="col-md-2">
        <label class="form-label">Avance 1</label>
        <input type="number" class="form-control" min="0" max="20" step="0.1"
               [(ngModel)]="av1" name="av1">
      </div>
      <div class="col-md-2">
        <label class="form-label">Avance 2</label>
        <input type="number" class="form-control" min="0" max="20" step="0.1"
               [(ngModel)]="av2" name="av2">
      </div>
      <div class="col-md-2">
        <label class="form-label">Avance 3</label>
        <input type="number" class="form-control" min="0" max="20" step="0.1"
               [(ngModel)]="av3" name="av3">
      </div>
      <div class="col-md-2">
        <label class="form-label">Participación</label>
        <input type="number" class="form-control" min="0" max="20" step="0.1"
               [(ngModel)]="participacion" name="participacion">
      </div>
      <div class="col-md-2">
        <label class="form-label">Proyecto</label>
        <input type="number" class="form-control" min="0" max="20" step="0.1"
               [(ngModel)]="proyecto" name="proyecto">
      </div>
      <div class="col-md-2">
        <label class="form-label">Nota final</label>
        <input type="number" class="form-control" min="0" max="20" step="0.1"
               [(ngModel)]="final" name="final">
      </div>
    </div>
    <div class="mt-3 d-flex gap-2">
      <!-- habilitado si hay sección y (estudiante seleccionado o estás editando) y hay algún valor -->
      <button type="submit" class="btn btn-primary"
              [disabled]="!seccionId || (!estudianteId && !editId) || !formTieneAlgunaNota() || loading">
        Guardar
      </button>
      <button type="button" class="btn btn-secondary" (click)="limpiar()">Limpiar</button>
    </div>
  </form>

  <h3 class="mb-3">Notas de la sección</h3>
  <div class="table-responsive" *ngIf="notas?.length; else noData">
    <table class="table table-bordered align-middle">
      <thead class="table-light">
        <tr>
          <th>Estudiante</th>
          <th>Av1</th>
          <th>Av2</th>
          <th>Av3</th>
          <th>Part.</th>
          <th>Proyecto</th>
          <th>Final</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let n of notas">
          <td>{{ n.estudiante_codigo || '' }} - {{ n.estudiante_nombre || '' }}</td>
          <td>{{ n.av1 ?? n.avance1 ?? '' }}</td>
          <td>{{ n.av2 ?? n.avance2 ?? '' }}</td>
          <td>{{ n.av3 ?? n.avance3 ?? '' }}</td>
          <td>{{ n.part ?? n.participacion ?? '' }}</td>
          <!-- ✅ usamos el helper para evitar $any/‘as any’ en template -->
          <td>{{ valProyecto(n) }}</td>
          <td>{{ n.final ?? n.nota_final ?? '' }}</td>
          <td>
            <button class="btn btn-sm btn-warning me-1" (click)="editar(n)">Editar</button>
            <button class="btn btn-sm btn-danger" (click)="eliminar(n.id)">Eliminar</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  <ng-template #noData>
    <div class="text-muted">Selecciona una sección para ver sus notas.</div>
  </ng-template>
</div>
